---
title: "R Notebook"
output: html_notebook
---


```{r}
#/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission
#library(devtools)
#devtools::install_github("kkeenan02/diveRsity")
library(diveRsity)
```

# Read in the metadta

```{r}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
#Read in the table with final samples used in analyses without admixed/migrant individuals
gone_meta <- read_excel(path = "/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Figures and Tables/Supplementary_submission_grypus_GONE_investigation.xlsx")

#Remove samples not included in the final dataset and admixed/migrant individuals
gone_meta <- gone_meta %>%
  filter(`Included in final dataset` == "Y") #%>%
  #filter(`Sample ID` != "HG517", `Sample ID` != "HG301" , `Sample ID` != "HG589")
  
#Rename one sample with a hyphen so plink can identify it later while running GONe
#gone_meta <- gone_meta %>%
#  mutate(
#    `Sample ID` = case_when(
#    `Sample ID` == "S04-06" ~ "S0406",
#    TRUE ~ `Sample ID`
#  ))

#Filter out a list of sample IDs per locality
metadata <- gone_meta %>%
  group_by(`Geographic location`) %>%
  mutate(`sample_id` = paste0(`Sample ID`, "_nuDNA_aligned_sorted")) %>%
  dplyr::select(`sample_id`, `Geographic location`) %>%
  rename(location=`Geographic location`)
```


# Prepare the input file from a VCF
```{r}
library(vcfR)
library(adegenet)

#Read in the vcf file
vcf <- read.vcfR("/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/angsd2vcf_no_shetland_output_no_HG589.vcf.recode.vcf")

samples_to_drop <- c("D01638_nuDNA_aligned_sorted", "D05320_nuDNA_aligned_sorted", "D00579_nuDNA_aligned_sorted")

# Drop the unwanted samples
vcf_filtered <- vcf
vcf_filtered@gt <- vcf@gt[, !(colnames(vcf@gt) %in% samples_to_drop), drop = FALSE]

sample_names <- colnames(vcf_filtered@gt)  # Accessing the genotype matrix to get sample names
print(sample_names)
vcf <- vcf_filtered

genind_obj <- vcfR2genind(vcf)
```


```{r}

#install.packages("adegenet")
# Check if sample names match
sample_ids <- indNames(genind_obj)

# Match and reorder your metadata
metadata_ordered <- metadata[match(sample_ids, metadata$sample_id), ]

# Check that everything lines up
stopifnot(all(sample_ids == metadata_ordered$sample_id))

# Assign population (location)
pop(genind_obj) <- as.factor(metadata_ordered$location)
library(adegenet)

#genepop_data <- genind2genpop(genind_obj)
#summary(genepop_data)

#install.packages("graph4lg")
library(graph4lg)

genepop <- genind_to_genepop(genind_obj)
write.table(genepop, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/genepop.txt", quote=FALSE, row.names=FALSE, col.names = FALSE)
head(genepop)
```


```{r}
#tst2 <- divMigrate(genepop, plot_network = TRUE, boots = 10, stat = "Nm", para = FALSE)
#tst100 <- divMigrate(genepop, plot_network = TRUE, boots = 100, stat = "Nm", para = FALSE)

#tst1000 <- divMigrate(genepop, plot_network = FALSE, boots = 1000, stat = "Nm", para = FALSE)

#Reordered 
tst1000_reordered <- divMigrate(genepop, plot_network = FALSE, boots = 1000, stat = "Nm", para = FALSE)

#saveRDS(tst1000_reordered, file = "/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/tst1000_reordered_divMigrate_output_morten.rds")

#saveRDS(tst1000, file = "/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/tst1000_divMigrate_output.rds")

#tst1000 <- readRDS("/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/tst1000_reordered_divMigrate_output_morten.rds")

tst100 <- tst1000 

tst100 <- tst1000_reordered

```


```{r}
library(igraph)
library(ggraph)
library(tidygraph)
library(ggplot2)

#Pop names (they are alphabetized)
pop_names<- metadata %>%
  select(location) %>%
  unique() %>%
  arrange((location))

pop_names<- as.character(pop(genind_obj)) %>%
  as.tibble() %>%
  ungroup() %>%
  unique() %>%
  arrange(value) %>%
  rename(location=value)

pop_names$region <- case_when(
  pop_names$location %in% c("Sable Island", "USA") ~ "NW Atlantic",
  pop_names$location %in% c("Iceland NW", "Iceland SE", "Kola", "Froan", "Isle of May", "Wales", "Wadden Sea") ~ "NE Atlantic",
  pop_names$location %in% c("Belt Sea", "The Sound", "Ertholmene", "Stockholm Archipelago", "Gulf of Riga", "Gulf of Finland", "Bothnian Bay") ~ "Baltic",
  TRUE ~ "Other"  # for any populations that might not match
)

colors <- c(
  "NE Atlantic" = "#FF8C00",
  "Baltic" = "#B22222",
  "NW Atlantic" = "#5F9EA0"
)

# Step 1: Use your matrix
rel_mig <- tst100$nmRelMig
sig <- tst100$nmRelMigSig

# Step 2: Remove non-significant edges (i.e., p > 0.05)
rel_mig[!is.na(sig) & sig > 0.05] <- 0

# Step 3: Make graph object from matrix
g <- graph_from_adjacency_matrix(rel_mig, mode = "directed", weighted = TRUE, diag = FALSE)

# Optional: name the nodes (adjust these to your real population names if you have them)
#V(g)$name <- paste0("Pop", 1:vcount(g))
V(g)$name <- pop_names$location
V(g)$region <- pop_names$region
# Step 4: Convert to tidygraph
tg <- as_tbl_graph(g)

# *** NEW: Filter by weight >= 0.3 ***
tg <- tg %>% activate(edges) %>% filter(weight >= 0.5)

# Step 5: Pretty plot with ggraph
ggraph(tg, layout = "fr") +  # or use "circle", "kk", etc.
  geom_edge_fan(aes(width = weight, alpha = weight), color = "#377eb8") +
  geom_node_point(size = 5, color = "#e41a1c") +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  theme_void() +
  ggtitle("Significant Relative Migration Network")

ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight),
    color = "#377eb8",
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_color_manual(values = colors) +
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")
```


```{r}
library(igraph)
library(ggraph)
library(tidygraph)
library(ggplot2)
library(dplyr)

# Pop names (they are alphabetized)
pop_names <- metadata %>%
  select(location) %>%
  unique() %>%
  arrange(location)

pop_names <- as.character(pop(genind_obj)) %>%
  as.tibble() %>%
  ungroup() %>%
  unique() %>%
  arrange(value) %>%
  rename(location = value)

# Assign regions to populations
pop_names$region <- case_when(
  pop_names$location %in% c("Sable Island", "USA") ~ "NW Atlantic",
  pop_names$location %in% c("Iceland NW", "Iceland SE", "Kola", "Froan", "Isle of May", "Wales", "Wadden Sea") ~ "NE Atlantic",
  pop_names$location %in% c("Belt Sea", "The Sound", "Ertholmene", "Stockholm Archipelago", "Gulf of Riga", "Gulf of Finland", "Bothnian Bay") ~ "Baltic",
  TRUE ~ "Other"  # for any populations that might not match
)

colors <- c(
  "NE Atlantic" = "#FF8C00",
  "Baltic" = "#B22222",
  "NW Atlantic" = "#5F9EA0"
)

# Step 1: Use your matrix
rel_mig <- tst100$nmRelMig
sig <- tst100$nmRelMigSig

# Step 2: Remove non-significant edges (i.e., p > 0.05)
rel_mig[!is.na(sig) & sig > 0.05] <- 0

# Step 3: Make graph object from matrix
g <- graph_from_adjacency_matrix(rel_mig, mode = "directed", weighted = TRUE, diag = FALSE)

# Assign the population names and regions
V(g)$name <- pop_names$location
V(g)$region <- pop_names$region

# Step 4: Convert to tidygraph
tg <- as_tbl_graph(g)

# *** NEW: Filter by weight >= 0 ***
tg <- tg %>% activate(edges) %>% filter(weight >= 0.3)

# Step 5: Create a new edge attribute for the edge color based on region matching
tg <- tg %>%
  activate(edges) %>%
  mutate(edge_color = case_when(
    V(g)$region[from] == V(g)$region[to] ~ V(g)$region[from],  # If same region, use that region's color
    TRUE ~ "black"  # If different regions, use black
  ))

tg_within_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] == V(g)$region[to])

# Step 5b: Filter edges to only those between different regions
tg_between_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] != V(g)$region[to])

# Step 6: Plot the graph using the edge colors
ggraph(tg, layout = "kk") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")

ggraph(tg_between_regions, layout = "kk") +
  geom_edge_fan(
    aes(width = weight, alpha = weight),
    color = "black",  # You could also use a custom color or gradient
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_color_manual(values = colors) +
  theme_void() +
  ggtitle("Migration Between Different Regions (Weight ≥ 0.3)") 

# Step 8: Plot only within-region migration
ggraph(tg_within_regions, layout = "kk") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Edge color by region
  scale_color_manual(values = colors) +       # Node color by region
  theme_void() +
  ggtitle("Migration Within Same Region (Weight ≥ 0.3)")

```

# Circle plot layout

```{r}
library(igraph)
library(ggraph)
library(tidygraph)
library(ggplot2)
library(dplyr)
library(ggeasy)

# Pop names (they are alphabetized)
pop_names <- as.character(pop(genind_obj)) %>%
  as.tibble() %>%
  ungroup() %>%
  unique() %>%
  arrange(value) %>%
  rename(location = value)

# Assign regions to populations
#pop_names$region <- case_when(
#  pop_names$location %in% c("Sable Island", "USA") ~ "NW Atlantic",
#  pop_names$location %in% c("Iceland NW", "Iceland SE", "Kola", "Froan", "Isle of May", "Wales", "Wadden Sea") ~ "NE Atlantic",
#  pop_names$location %in% c("Belt Sea", "The Sound", "Ertholmene", "Stockholm Archipelago", "Gulf of Riga", "Gulf of Finland", "Bothnian Bay") ~ "Baltic",
#  TRUE ~ "Other"  # for any populations that might not match
#)

pop_names$region <- case_when(
  pop_names$location %in% c("2_NW_A Sable Island", "2_NW_B USA") ~ "NW Atlantic",
  pop_names$location %in% c("1_NE_G Iceland NW", "1_NE_F Iceland SE", "1_NE_E Froan", "1_NE_D Kola", "1_NE_C Wales", "1_NE_B Isle of May", "1_NE_A Wadden Sea") ~ "NE Atlantic",
  pop_names$location %in% c("3_Baltic_G Belt Sea", "3_Baltic_F The Sound", "3_Baltic_E Ertholmene", "3_Baltic_D Gulf of Riga", "3_Baltic_C Gulf of Finland", "3_Baltic_B Stockholm Archipelago", "3_Baltic_A Bothnian Bay") ~ "Baltic",
  TRUE ~ "Other"  # for any populations that might not match
)

colors <- c(
  "NE Atlantic" = "#FF8C00",
  "Baltic" = "#B22222",
  "NW Atlantic" = "#5F9EA0",
  "Other" = "black",
  "black" = "black"
)

# Step 1: Use your matrix
rel_mig <- tst100$nmRelMig
sig <- tst100$nmRelMigSig

# Step 2: Remove non-significant edges (i.e., p > 0.05)
rel_mig[!is.na(sig) & sig > 0.05] <- 0

# Step 3: Make graph object from matrix
g <- graph_from_adjacency_matrix(rel_mig, mode = "directed", weighted = TRUE, diag = FALSE)

# Assign the population names and regions
V(g)$name <- pop_names$location
V(g)$region <- pop_names$region

# Step 4: Convert to tidygraph
tg <- as_tbl_graph(g)

# *** NEW: Filter by weight >= 0 ***
tg <- tg %>% activate(edges) %>% filter(weight >= 0.3)

# Step 5: Create a new edge attribute for the edge color based on region matching
tg <- tg %>%
  activate(edges) %>%
  mutate(edge_color = case_when(
    V(g)$region[from] == V(g)$region[to] ~ V(g)$region[from],  # If same region, use that region's color
    TRUE ~ "black"  # If different regions, use black
  ))

tg_within_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] == V(g)$region[to])

# Step 5b: Filter edges to only those between different regions
tg_between_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] != V(g)$region[to])


# Step 6: Plot the graph using the edge colors
tg_all <- ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.2)) +
  scale_edge_alpha(range = c(0.5, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  easy_remove_legend() +
  theme(plot.title = element_blank())

tg_legend <- ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.2)) +
  scale_edge_alpha(range = c(0.5, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  easy_remove_legend() +
  theme(plot.title = element_blank())

tg_between <- ggraph(tg_between_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight),
    color = "black",  # You could also use a custom color or gradient
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.2)) +
  scale_edge_alpha(range = c(0.5, 1)) +
  scale_color_manual(values = colors) +
  theme_void() +
  easy_remove_legend() +
  theme(plot.title = element_blank())

tg_between_legend <- ggraph(tg_between_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight),
    color = "black",  # You could also use a custom color or gradient
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.2)) +
  scale_edge_alpha(range = c(0.5, 1)) +
  scale_color_manual(values = colors) +
  theme_void() +
  #easy_remove_legend() +
  theme(plot.title = element_blank())

# Step 8: Plot only within-region migration
tg_within <- ggraph(tg_within_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Edge color by region
  scale_color_manual(values = colors) +       # Node color by region
  theme_void() +
  #ggtitle("Migration Within Same Region (Weight ≥ 0.3)")
  easy_remove_legend() +
  theme(plot.title = element_blank())

tg_within_legend <- ggraph(tg_within_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Edge color by region
  scale_color_manual(values = colors) +       # Node color by region
  theme_void() +
  #ggtitle("Migration Within Same Region (Weight ≥ 0.3)")
  #easy_remove_legend() +
  theme(plot.title = element_blank())
```


```{r}
ggsave(plot = tg_all, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_all.svg", width = 5, height = 5,device = "svg")
ggsave(plot = tg_all, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_all.pdf", width = 5, height = 5,device = "pdf")
ggsave(plot = tg_legend, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_legend.svg", width = 5, height = 5,device = "svg")

```

```{r}
ggsave(plot = tg_between, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_between.svg", width = 5, height = 5,device = "svg")
ggsave(plot = tg_between, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_between.pdf", width = 5, height = 5,device = "pdf")
ggsave(plot = tg_between_legend, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_between_legend.svg", width = 5, height = 5,device = "svg")
```

```{r}
ggsave(plot = tg_within, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_within.svg", width = 5, height = 5,device = "svg")
ggsave(plot = tg_within, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_within.pdf", width = 5, height = 5,device = "pdf")
ggsave(plot = tg_within_legend, file="/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/Figures/divMigrate_within_legend.svg", width = 5, height = 5,device = "svg")
```


# tg_between with same scale
```{r}
ggraph(tg_between_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight),
    color = "black",  # You could also use a custom color or gradient
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 2.2), limits = c(0, 1)) +  # Ensure width is scaled up to 1
  scale_edge_alpha(range = c(0.5, 1), limits = c(0, 1)) +  # Ensure alpha is scaled up to 1
  scale_color_manual(values = colors) +
  theme_void() +
  easy_remove_legend() +
  theme(plot.title = element_blank())  # Remove plot title
```


```{r}
ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, color = edge_color),  # Use edge color but no alpha scaling
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 3.2)) +  # Adjust arrow thickness based on weight
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")
```


# Sand Box

```{r}
df_arranged
df <- igraph::as_data_frame(tg_within_regions)
df_arranged <- dplyr::arrange(df, edge_color)
df_arranged


tg_within_regions <- as_tbl_graph(df_arranged)

# Assign the population names and regions
V(tg_within_regions)$name <- pop_names$location
V(tg_within_regions)$region <- pop_names$region

df <- igraph::as_data_frame(tg_within_regions)
df_arranged <- dplyr::arrange(df, edge_color)


ggraph(tg_within_regions, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +
  geom_node_text(aes(label = name), repel = TRUE, size = 4) +
  scale_edge_width(range = c(0.2, 1.2)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Edge color by region
  scale_color_manual(values = colors) +       # Node color by region
  theme_void() +
  ggtitle("Migration Within Same Region (Weight ≥ 0.3)")

tg_within_regions
```


```{r}
ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), 
                 size = 4, 
                 color = "black", 
                 vjust = -1,  # Move text above the nodes
                 hjust = 0.5) +  # Center the text horizontally
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")

tg
  
tg %>%
  arrange(desc(region)) %>%
  ggraph(layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 5) +  # Color nodes by region
  geom_node_text(aes(label = name), 
                 size = 4, 
                 color = "black", 
                 vjust = -1,  # Move text above the nodes
                 hjust = 0.5) +  # Center the text horizontally
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")
```

# Old
```{r}
ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 25) +  # Increase node size for better visibility
  geom_node_text(aes(label = name), repel = FALSE, size = 3, color = "white") +  # Larger labels inside nodes
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")
```


```{r}

df <- igraph::as_data_frame(tg)
df_arranged <- dplyr::arrange(df, edge_color)

# Pop names (they are alphabetized)
pop_names <- metadata %>%
  select(location) %>%
  unique() %>%
  arrange(location)

pop_names <- as.character(pop(genind_obj)) %>%
  as.tibble() %>%
  ungroup() %>%
  unique() %>%
  arrange(value) %>%
  rename(location = value)

# Assign regions to populations
pop_names$region <- case_when(
  pop_names$location %in% c("Sable Island", "USA") ~ "NW Atlantic",
  pop_names$location %in% c("Iceland NW", "Iceland SE", "Kola", "Froan", "Isle of May", "Wales", "Wadden Sea") ~ "NE Atlantic",
  pop_names$location %in% c("Belt Sea", "The Sound", "Ertholmene", "Stockholm Archipelago", "Gulf of Riga", "Gulf of Finland", "Bothnian Bay") ~ "Baltic",
  TRUE ~ "Other"  # for any populations that might not match
)

colors <- c(
  "NE Atlantic" = "#FF8C00",
  "Baltic" = "#B22222",
  "NW Atlantic" = "#5F9EA0"
)

# Step 1: Use your matrix
rel_mig <- tst100$nmRelMig
sig <- tst100$nmRelMigSig

# Step 2: Remove non-significant edges (i.e., p > 0.05)
rel_mig[!is.na(sig) & sig > 0.05] <- 0

# Step 3: Make graph object from matrix
g <- graph_from_adjacency_matrix(rel_mig, mode = "directed", weighted = TRUE, diag = FALSE)

# Assign the population names and regions
V(df_arranged)$name <- pop_names$location
V(df_arranged)$region <- pop_names$region

V(tg)$name <- pop_names$location
V(tg)$region <- pop_names$region

tg <- as_tbl_graph(df_arranged)

# Step 4: Convert to tidygraph
tg <- as_tbl_graph(g)

# *** NEW: Filter by weight >= 0 ***
tg <- tg %>% activate(edges) %>% filter(weight >= 0.3)

# Step 5: Create a new edge attribute for the edge color based on region matching
tg <- tg %>%
  activate(edges) %>%
  mutate(edge_color = case_when(
    V(g)$region[from] == V(g)$region[to] ~ V(g)$region[from],  # If same region, use that region's color
    TRUE ~ "black"  # If different regions, use black
  ))

tg_within_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] == V(g)$region[to])

# Step 5b: Filter edges to only those between different regions
tg_between_regions <- tg %>%
  activate(edges) %>%
  filter(V(g)$region[from] != V(g)$region[to])

ggraph(tg, layout = "circle") +
  geom_edge_fan(
    aes(width = weight, alpha = weight, color = edge_color),
    arrow = arrow(length = unit(3, "mm"), type = "closed"),
    end_cap = circle(3, 'mm')
  ) +
  geom_node_point(aes(color = region), size = 25) +  # Increase node size for better visibility
  geom_node_text(aes(label = name), repel = FALSE, size = 3, color = "white") +  # Larger labels inside nodes
  scale_edge_width(range = c(0.2, 2.5)) +
  scale_edge_alpha(range = c(0.3, 1)) +
  scale_edge_color_manual(values = colors) +  # Apply custom colors to edges
  scale_color_manual(values = colors) +  # Apply custom node colors
  theme_void() +
  ggtitle("Significant Relative Migration Network (Weight ≥ 0.3)")
```

# Order 

```{r}
#Update based on Morten's most recent comment
# keeping USA/Canada where they are, and then ordering from there on clockwise: NW Iceland, SE Iceland, Froan, Kola, Wales, Isle of May, Wadden Sea, Belt Sea, the Sound, Ertholmene, Riga, Finland, Stockholm, Bothnian Bay

```



## Order based on region and location
```{r}
#Old order
metadata_ordered$location1 <- case_when(
  metadata_ordered$location %in% c("Iceland NW") ~ "G Iceland NW",
  metadata_ordered$location %in% c("Iceland SE") ~ "F Iceland SE",
  metadata_ordered$location %in% c("Kola") ~ "E Kola",
  metadata_ordered$location %in% c("Froan") ~ "D Froan",
  metadata_ordered$location %in% c("Isle of May") ~ "C Isle of May",
  metadata_ordered$location %in% c("Wales") ~ "B Wales",
  metadata_ordered$location %in% c("Wadden Sea") ~ "A Wadden Sea",
  metadata_ordered$location %in% c("Sable Island") ~ "A Sable Island",
  metadata_ordered$location %in% c("USA") ~ "B USA",
  metadata_ordered$location %in% c("Belt Sea") ~ "G Belt Sea",
  metadata_ordered$location %in% c("The Sound") ~ "F The Sound",
  metadata_ordered$location %in% c("Ertholmene") ~ "E Ertholmene",
  metadata_ordered$location %in% c("Stockholm Archipelago") ~ "D Stockholm Archipelago",
  metadata_ordered$location %in% c("Gulf of Riga") ~ "C Gulf of Riga",
  metadata_ordered$location %in% c("Gulf of Finland") ~ "B Gulf of Finland",
  metadata_ordered$location %in% c("Bothnian Bay") ~ "A Bothnian Bay",
)



# Set up region-based prefixes (NE = 1, NW = 2, Baltic = 3)
metadata_ordered$region <- case_when(
  metadata_ordered$location1 %in% c("G Iceland NW", "F Iceland SE", "E Kola", "D Froan", "C Isle of May", "B Wales", "A Wadden Sea") ~ "1_NE",
  metadata_ordered$location1 %in% c("A Sable Island", "B USA") ~ "2_NW",
  metadata_ordered$location1 %in% c("G Belt Sea", "F The Sound", "E Ertholmene", "D Stockholm Archipelago", "C Gulf of Riga", "B Gulf of Finland", "A Bothnian Bay") ~ "3_Baltic",
  TRUE ~ "4_Other"
)
```


```{r}

#Update based on Morten's most recent comment
# keeping USA/Canada where they are, and then ordering from there on clockwise: NW Iceland, SE Iceland, Froan, Kola, Wales, Isle of May, Wadden Sea, Belt Sea, the Sound, Ertholmene, Riga, Finland, Stockholm, Bothnian Bay

#New order per Morten
metadata_ordered$location1 <- case_when(
  metadata_ordered$location %in% c("Iceland NW") ~ "G Iceland NW",
  metadata_ordered$location %in% c("Iceland SE") ~ "F Iceland SE",
  metadata_ordered$location %in% c("Froan") ~ "E Froan",
  metadata_ordered$location %in% c("Kola") ~ "D Kola",
  metadata_ordered$location %in% c("Wales") ~ "C Wales",
  metadata_ordered$location %in% c("Isle of May") ~ "B Isle of May",
  metadata_ordered$location %in% c("Wadden Sea") ~ "A Wadden Sea",
  metadata_ordered$location %in% c("Sable Island") ~ "A Sable Island",
  metadata_ordered$location %in% c("USA") ~ "B USA",
  metadata_ordered$location %in% c("Belt Sea") ~ "G Belt Sea",
  metadata_ordered$location %in% c("The Sound") ~ "F The Sound",
  metadata_ordered$location %in% c("Ertholmene") ~ "E Ertholmene",
  metadata_ordered$location %in% c("Gulf of Riga") ~ "D Gulf of Riga",
  metadata_ordered$location %in% c("Gulf of Finland") ~ "C Gulf of Finland",
  metadata_ordered$location %in% c("Stockholm Archipelago") ~ "B Stockholm Archipelago",
  metadata_ordered$location %in% c("Bothnian Bay") ~ "A Bothnian Bay",
)



# Set up region-based prefixes (NE = 1, NW = 2, Baltic = 3)
metadata_ordered$region <- case_when(
  metadata_ordered$location1 %in% c("G Iceland NW", "F Iceland SE", "E Froan", "D Kola", "C Wales", "B Isle of May", "A Wadden Sea") ~ "1_NE",
  metadata_ordered$location1 %in% c("A Sable Island", "B USA") ~ "2_NW",
  metadata_ordered$location1 %in% c("G Belt Sea", "F The Sound", "E Ertholmene", "D Gulf of Riga", "C Gulf of Finland", "B Stockholm Archipelago", "A Bothnian Bay") ~ "3_Baltic",
  TRUE ~ "4_Other"
)

# Combine prefix and location to create sortable population names
metadata_ordered$ordered_loc <- paste(metadata_ordered$region, metadata_ordered$location1, sep = "_")

# Assign to genind object with controlled order
pop(genind_obj) <- as.factor(metadata_ordered$ordered_loc)

# Convert to Genepop format
genepop <- genind_to_genepop(genind_obj)

write.table(
  genepop,
  file = "/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/genepop.txt",
  quote = FALSE,
  row.names = FALSE,
  col.names = FALSE
)

```


## Order based on just region
```{r}
# Set up region-based prefixes (NE = 1, NW = 2, Baltic = 3)
metadata_ordered$region <- case_when(
  metadata_ordered$location %in% c("Iceland NW", "Iceland SE", "Kola", "Froan", "Isle of May", "Wales", "Wadden Sea") ~ "1_NE",
  metadata_ordered$location %in% c("Sable Island", "USA") ~ "2_NW",
  metadata_ordered$location %in% c("Belt Sea", "The Sound", "Ertholmene", "Stockholm Archipelago", "Gulf of Riga", "Gulf of Finland", "Bothnian Bay") ~ "3_Baltic",
  TRUE ~ "4_Other"
)

# Combine prefix and location to create sortable population names
metadata_ordered$ordered_loc <- paste(metadata_ordered$region, metadata_ordered$location, sep = "_")

# Assign to genind object with controlled order
pop(genind_obj) <- as.factor(metadata_ordered$ordered_loc)

# Convert to Genepop format
genepop <- genind_to_genepop(genind_obj)

write.table(
  genepop,
  file = "/Users/morganmccarthy/Documents/Manuscripts/2022/Grey seal/ddRAD/Molecular Ecology Submission/Resubmission/divMigrate/genepop.txt",
  quote = FALSE,
  row.names = FALSE,
  col.names = FALSE
)

```

```{r}
library(reshape2)
library(ggplot2)
library(dplyr)

# Step 0: Ensure rel_mig has proper row and column names
rownames(rel_mig) <- colnames(rel_mig) <- pop_names$location

# Step 1: Convert matrix to long format
rel_mig_df <- melt(rel_mig, varnames = c("from", "to"), value.name = "migration")

# Step 2: Filter out non-significant or zero values
rel_mig_df <- rel_mig_df %>%
  filter(!is.na(migration), migration > 0)

# Step 3: Add region info from pop_names
rel_mig_df <- rel_mig_df %>%
  left_join(pop_names %>% rename(region_from = region), by = c("from" = "location")) %>%
  left_join(pop_names %>% rename(region_to = region), by = c("to" = "location"))

# Step 4: Create region-prioritized population order (NE, NW, Baltic)
ordered_pops <- pop_names %>%
  mutate(region = factor(region, levels = c("NW Atlantic", "NE Atlantic", "Baltic"))) %>%
  arrange(region, location) %>%
  pull(location)

# Step 5: Apply ordering to the factor levels
rel_mig_df$from <- factor(rel_mig_df$from, levels = ordered_pops)
rel_mig_df$to <- factor(rel_mig_df$to, levels = ordered_pops)

# Step 6: Plot the heatmap
ggplot(rel_mig_df, aes(x = to, y = from, fill = migration)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkred") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_blank()
  ) +
  labs(fill = "Relative Migration")

```


```{r}
library(reshape2)
library(ggplot2)
library(dplyr)

# Step 0: Ensure rel_mig has proper row and column names
rownames(rel_mig) <- colnames(rel_mig) <- pop_names$location

# Step 1: Convert matrix to long format
rel_mig_df <- melt(rel_mig, varnames = c("from", "to"), value.name = "migration")

# Step 2: Filter out non-significant or zero values
#rel_mig_df <- rel_mig_df %>%
#  filter(!is.na(migration), migration >= 0)

# Step 3: Add region info from pop_names
rel_mig_df <- rel_mig_df %>%
  left_join(pop_names %>% rename(region_from = region), by = c("from" = "location")) %>%
  left_join(pop_names %>% rename(region_to = region), by = c("to" = "location"))

# Step 4: Create region-prioritized population order (NW, NE, Baltic)
ordered_pops <- pop_names %>%
  mutate(region = factor(region, levels = c("NW Atlantic", "NE Atlantic", "Baltic"))) %>%
  arrange(region, location) %>%
  pull(location)

# Step 5: Apply ordering to the factor levels
rel_mig_df$from <- factor(rel_mig_df$from, levels = ordered_pops)
rel_mig_df$to <- factor(rel_mig_df$to, levels = ordered_pops)

# Step 6: Keep only the upper triangle
rel_mig_df <- rel_mig_df %>%
  filter(as.numeric(from) < as.numeric(to))

# Step 7: Plot the heatmap
ggplot(rel_mig_df, aes(x = to, y = from, fill = migration)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "darkred") +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title = element_blank()
  ) +
  labs(fill = "Relative Migration")

```

